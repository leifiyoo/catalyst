name: AI Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Ask AI for Triage
        id: ai_request
        run: |
          # Anfrage an OpenRouter
          RESPONSE=$(curl -s https://openrouter.ai/api/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENROUTER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"google/gemma-2-9b-it:free\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"Du bist ein Support-Assistent. Analysiere das Ticket: Ist es ein Bug in der Software oder ein Problem am Gerät des Nutzers? Wenn Gerät/User-Fehler: Gib eine Hilfestellung. Wenn Software-Fehler: Antworte mit [BUG].\"},
                {\"role\": \"user\", \"content\": \"Title: ${{ github.event.issue.title }}\n\nBody: ${{ github.event.issue.body }}\"}
              ]
            }")
          
          # Extrahiere die Antwort sicher mit jq
          COMMENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "Fehler: Keine Antwort erhalten"')
          
          # Sicherer Export für mehrzeilige Texte
          {
            echo "comment<<EOF"
            echo "$COMMENT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post Comment
        if: steps.ai_request.outputs.comment != ''
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "${{ steps.ai_request.outputs.comment }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
