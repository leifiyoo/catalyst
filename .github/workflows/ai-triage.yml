name: AI Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Ask AI for Triage
        id: ai_request
        env:
          OPENROUTER_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # 1. JSON Payload erstellen
          jq -n \
            --arg sys "Du bist ein Support-Assistent. Analysiere das Ticket. Wenn Hardware: Hilfestellung. Wenn Software: Antworte [BUG]." \
            --arg user "Title: $ISSUE_TITLE\n\nBody: $ISSUE_BODY" \
            '{
              model: "openrouter/pony-alpha",
              messages: [
                {role: "system", content: $sys},
                {role: "user", content: $user}
              ]
            }' > payload.json

          # 2. Anfrage mit -i (zeigt Header) und Fehlerausgabe
          # Wir nutzen hier eine temporäre Datei für die Antwort
          curl -s -i https://openrouter.ai/api/v1/chat/completions \
            -H "Authorization: Bearer $OPENROUTER_KEY" \
            -H "Content-Type: application/json" \
            -H "HTTP-Referer: https://github.com/leifiyoo" \
            -H "X-Title: GitHub AI Bot" \
            -d @payload.json > full_response.txt

          # 3. Antwort sauber trennen (Header entfernen für jq)
          # Wir suchen den Anfang des JSON-Bodys ({)
          RESPONSE_JSON=$(sed -n '/{/,$p' full_response.txt)
          
          CONTENT=$(echo "$RESPONSE_JSON" | jq -r '.choices[0].message.content // empty')
          
          if [ -z "$CONTENT" ]; then
            # Falls leer, posten wir den Inhalt der Textdatei zur Diagnose
            DIAGNOSE=$(cat full_response.txt | head -n 20)
            echo "comment<<EOF"
            echo "**Verbindungs-Diagnose:**"
            echo "\`\`\`text"
            echo "$DIAGNOSE"
            echo "\`\`\`"
            echo "EOF"
          else
            echo "comment<<EOF"
            echo "$CONTENT"
            echo "EOF"
          fi >> "$GITHUB_OUTPUT"

      - name: Post Comment
        if: steps.ai_request.outputs.comment != ''
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "${{ steps.ai_request.outputs.comment }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
