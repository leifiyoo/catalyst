name: AI Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Ask AI for Triage
        id: ai_request
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # 1. JSON Payload erstellen
          jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY" \
            '{
              model: "openrouter/pony-alpha",
              messages: [
                {
                  role: "user", 
                  content: ("Analysiere dieses GitHub Ticket: Titel: " + $title + ". Inhalt: " + $body + ". Ist es ein Bug? Antworte mit [BUG] oder gib Hilfe bei User-Fehlern.")
                }
              ],
              reasoning: {
                enabled: true
              }
            }' > payload.json

          # 2. Anfrage an OpenRouter
          RESPONSE=$(curl -s https://openrouter.ai/api/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENROUTER_API_KEY" \
            -d @payload.json)

          # 3. Antwort sicher extrahieren (Fehler korrigiert)
          # Wir pr端fen erst, ob die Antwort g端ltig ist
          if echo "$RESPONSE" | jq -e '.choices[0].message.content' > /dev/null 2>&1; then
            COMMENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          else
            # Falls ein Fehler von OpenRouter kommt, zeigen wir ihn an
            COMMENT="**Diagnose-Info:** Die KI hat keine g端ltige Antwort gesendet. 
            Antwort von OpenRouter: \`$RESPONSE\`"
          fi
          
          # 4. Export f端r GitHub
          {
            echo "comment<<EOF"
            echo "$COMMENT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post Comment
        if: steps.ai_request.outputs.comment != ''
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "${{ steps.ai_request.outputs.comment }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
